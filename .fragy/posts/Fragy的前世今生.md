---
title: Fragy的前世今生
date: 2022-05-06 00:34:52
category: 开发
---

Fragy是一个由pwp Software研发的博客框架，如你所见，它能够以一个相当简约、干净的形态把文章呈现到你的面前。

经过漫长的开发，Fragy终于达到了可以正式落地的水准。当然，现在的它还存在非常多的不足和功能缺位，这些都会在未来逐步迭代、更新。

这篇文章并不是单纯地去向你推销Fragy，告诉你它有多好用、多强大，相反，这只是一个简单的记录，记录Fragy的前世今生。

<!-- more -->

## 0x00 缘起

Fragy这个项目立项非常非常早，它的首次代码提交可以追溯到2020年。之所以做这个东西，只是单纯地因为我厌倦了Hexo这一类的博客框架，希望自己能重新打造一个真正轻量化、敏捷化的新东西。

我将其命名为了“Fragy”，取了“Fragment”的前几个字母，再给它加上了一个“y”，使它看起来像是一个形容词。

之所以其这个名字，是因为我希望用它打造出来的页面能有相当高的自由度，允许你把各种各样碎片化的组件以非常便利地方式插入到页面中，同时它又可以继承动态博客的一些特性，让文章不再只是一段固化的、编译好的HTML，它能够以一个更加灵活的方式呈现出来。

## 0x01 思绪

相较于WordPress等趋向于CMS的博客框架，Hexo等生成式的博客框架确实在博客领域内迈出了全新的一步，他们通过静态生成所有博客页面直接拉底了博客的部署门槛，现在你可以很轻松地把这类静态博客部署到任何地方。如果你觉得Hexo的编译速度比较慢，你还可以考虑Hugo，它和Hexo一样是一个静态页面生成机，得益于其技术栈本身的优越性，它要比Hexo快很多。

这一系列基于静态生成页面的框架已经让构建一个博客的成本变得非常非常低，在互联网上它们的应用也颇为广泛。但是在这个世界上，万事万物都是不完美的。之前我的个人博客也是用Hexo搭建，起初过程是愉快的，但是当我的想法随着时间变得越来越多时，我开始魔改主题、开始折腾编译上传的自动化、开始研究插件、开始向主题和框架里注入这样、那样的代码，久而久之，事情变得不快乐了起来。

我发现这类框架并不敏捷，哪怕我只是改了一点点内容，想要让它生效，我不得不走一整套固定的编译上传流程，非常繁琐。同时在框架允许主题使用的技术栈内，想要实现高度的自定义、让博客拥有很多丰富的功能并不简单。正如GitHub上你能看见的这些框架的生态一样，很多开发者为了实现他们想要的东西做了非常多的工作。

然而，现在的前端开发已经走向了一条非常成熟的工业化道路，从基础Web框架到上层的应用组件，成熟的解决方案有很多。主流的静态页面生成框架并没有针对主题的开发体验以及框架的敏捷性做太多的投入，它们的焦点往往集中在“生成”。

它们的设计目标都只是支撑一个功能相对单一化、复杂度低的站点，因而当你想要在它们之上做一些丰富的自定义，这些框架反而会变得笨重起来，而且受限于静态生成这个底层设计本身，框架自身的敏捷性更是会受到限制。这种底层逻辑会导致本身轻量的东西到最后慢慢地变得越来越重，例如为了实现你想要的效果，你不得不在主题里引入各种各样的外部脚本，在框架内打入这样、那样的插件。

而Fragy想要实现突破的，就是这些限制。

## 0x02 开创

在设计Fragy的架构时，WordPress的一些设计给了我非常大的启发。众所周知WordPress是用PHP开发的，适用于它的主题、插件自然也不例外。这意味着在开发上，主题开发者可以在一个非常高的自由度下施展自己的才华，甚至实现一些WordPress本身不具备的、不在其目标设计范围内的各类能力。

这是当下WordPress生态繁荣的基石，如果WordPress做了很多过度的封装，或者在开发层面给开发者设下很多条框，那么开发者的才华就不能得到最大化的释放，也不会有现在各式各样、功能各异的主题出现。

Fragy的设计极大程度上借鉴了WordPress的这一套思路，我们并不希望给开发者设下过多的限制或是门槛，而是希望开发者能够完全发挥他们的才华，甚至让有一定编程能力的用户也能够非常便利地增强他们的页面，使其能够符合他们的预期。

### 设计模式

得益于现代前端技术已经转入了一个高效率的工业化时代，站在工业化框架的基础上，我们能比较容易地实现这件事情。通过灵活运用Vue和Webpack，我们可以完全让主题承载页面在“呈现”层面的所有能力，给予开发者最大的自由度。

相较于Hexo之类的框架，Fragy还有一个非常大的不同 —— 它彻底丢弃了“宿主与插件”这一套设计模式。在Hexo这一类静态生成框架中，“插件”最核心的一个能力就是注入、操作页面的生成流程，以此实现功能层面的拓展，例如额外生成一个SiteMap、额外生成RSS源、给文章做加密等等。而在WordPress中，插件的核心功能则是给主题（当然也可以理解为整个站点）赋予一些额外的驱动力，例如页面静态化、SEO优化、垃圾评论过滤等等。

在现代工业化的前端开发下，不论是拓展页面的功能，还是给页面添加一些额外的驱动力，这些都可以单纯地通过载入、使用某一些npm软件包实现。换言之，我们可以换一个角度看待插件，由于在Fragy的架构中，页面几乎完全由主题来驱动，因而插件可以被看作是主题一部分，是主题依赖的一个软件包，而主题借由它去实现了功能层面上的某种拓展，最终体现到页面上。Fragy作为框架，它只需要给主题开放一个允许它介入编译流程的方式即可。

这就是我们提出的一个全新的设计模式 —— 主题完全驱动页面，用户能够使用的所有能力都跟随主题一起ship。

在这种模式下，前端工业化的优势能够得到充分发挥，同时我们还可以规避一些其他主流框架很常见的插件与主题存在这样、那样冲突的问题，在这一套模式下，主题开发者会保证主题提供的所有能力都是完全可靠的。

### 技术选型

技术选型方面，Fragy选用的是SPA + Meta数据生成模式，对比现在主流、时髦的静态页面生成，这一套确实是略显落后了。不过我们仍然坚定地用这一套技术来推进Fragy的开发。在Vue的开发生态里，SSR/SSG相对而言并不是那么容易被理解和接纳，会给主题开发者带来额外的心智负担；同时也正如上文所说，这一套方案本身就会丢失一些敏捷性，生成元数据带来的开销和生成整个页面相比必然是更低的，同时由于一部分解析、渲染的任务转移到了客户端，SPA也可以避免改一点点东西就需要被迫生成一整个站点的尴尬情况。

不可否认的是，不论是SEO还是页面体验，静态生成的页面始终要优于SPA。虽然SPA下我们确实能够通过一系列的优化手段去逼近静态页面的体验，但是相较于静态页面而言，SPA的体验还是要稍弱一些。这是一件没有办法的事情，毕竟任何的技术方案肯定都有其优点与缺陷，我们选择的是更契合我们想法与预期的那一套。

其实我个人并不认同技术领域内很多同学认为“新 = 正确”的想法，特别是在我看到一些项目因为盲目地去追求新潮，把一个很轻的东西变得很重、很复杂的时候。纵然现在前端技术非常发达，但仍然有新的页面在使用 jQuery，甚至是原生的 API。在某些场景下，相较于Vue 3，Vue 2反而是最合适的选择，例如当你需要考虑页面兼容性的时候。

任何的事情都没有绝对的对与错，世界没有那么二极管化，最契合的一套技术往往才是最好的。

## 0x03 前世

Fragy有一个早期版本，它具备Fragy的所有核心思想，并通过技术实现验证了这一套理念的可行性。

这个版本是基于Vue 2 + Webpack 4实现的，也就是 `@vue/cli` 在Vue 2默认使用的那一套搭配。我们实现了一套十分灵活的主题引入、开发机制，并巧妙地通过一个CLI Tool把Fragy隐藏到了用户不关心，甚至连开发者都不太关心的 `node_modules` 内。

它用一个十分简单且干净的方式实现了由主题驱动页面、框架提供基础能力支撑的架构。独立的Node脚本负责对文章进行解析，提取元数据；Webpack负责对其他静态资源做处理；框架主Entry负责寻找主题入口并加载主题，同时在全局注入一些经过处理的框架配置等。在需求明确的情况下，一个对Vue比较熟悉的前端开发者能够在非常短的时间内将它实现出来，它并不复杂。

也同样得益于现代前端的工业化，渲染Markdown文档、对代码进行高亮、在文章内插入评论区等也都有很成熟的解决方案，主题本身的实现难度也不高。对于一个非常简单的博客主题，开发者只需要实现一个简单的界面结构，将由各个依赖处理好的内容放进去即可。

由于在开发这个版本的过程中，我全程走了一遍一个主题从0到1的开发过程，在我的整个开发体验中，我能够切实地感觉到这个框架极高的自由度，同时它又不会给开发者带来很高的技术门槛或者心智压力。

这种切实的体验让我对它的发展潜力充满了信心，但很不幸的是这一切是发生在1-2年前的事情，在这段时间里前端技术发生了非常大的变化。如你我所见，Webpack和Vue更新了大版本、Evan You带来的Vite横空出世、微前端的概念在前端技术圈内声音愈发增大，这一切都让选型本身就显得不那么时髦的Fragy变得更加不现代化，而且由于Vue的迭代，Vue 2的生态随着时间的推移也会转移到Vue 3上，以至于如果我们希望Fragy能得到一个更好的发展，我们就不得不去更新它的技术栈。

## 0x04 今生

其实很早我就产生了用相对新一些的技术栈对Fragy进行一次规模适中的重构，实际上从Vue 2迁移到Vue 3、从Webpack 4迁移到Webpack 5，这一系列事情都是不需要花费多少时间和精力的，毕竟Vue 3虽然提供了全新的Composition API，但是他们并没有抛弃原来的那一套写法，保持了一定的向下兼容。

但是Fragy的新版最终还是延后到了2022年才正式落地，其中一个很大的原因是我们的项目并没有直接使用Webpack，打包经过了一层 `@vue/cli`，同时核心实现上对它提供的 `vue.config.js` 存在一定的依赖。维护它的团队很早就有了将项目重心往Webpack 5与Vue 3迁移的计划，也就是v5.x的迭代，但是这个迭代的进展速度并不是非常理想，当它最终稳定下来之后，时间已经到了2021年的下半年。

在2021的后半段时间里，Fragy成功完成了迁移，实现了重生。在这个过程中我们有一些新的发现、新的想法，以至于到最终落地，时间已经来到了2022年。

### MarkVue

MarkVue是我编写的一个具有实验性质的Vue 3组件，它能够即时地在运行时编译、执行Markdown文档里存在的Vue SFC组件。

当写完这个东西的时候，我顷刻就意识到它能够与Fragy做一个非常好的结合，它不单单能够让Fragy的能力变得更加丰富，它还能够极大程度地提升Fragy的敏捷性。由于MarkVue的编译、渲染流程完全发生在运行时，这意味着我们对Markdown文档的一切更改在不需要经过任何编译的情况下就可以直接作用到页面上，这意味着我们可以用代码非常灵活地控制某一篇文章的展示效果，也可以非常方便地对它做迭代。

诚然，集成MarkVue会带来一些负面影响，比如它会显著地增加打包产物的体积，需要主题开发者去做一些针对性的适配等。但是我们还是默认以可选功能的形式集成了它，因为它给整个项目带来的提升要远大于负面影响，同时它带来的负面影响也是可以用一些优化手段来抵消的。

### GitHub Mode

这个模式其实并不具备太多的实用性，因为它需要主题对这个模式做一些特别的支持。

它更多是Fragy灵活性的一个体现，由于Fragy本身采用了SPA + Meta数据的技术结构，实际上在条件允许的情况下，Meta数据并不需要通过脚本去生成，而是可以走一些现成的API直接获取。

GitHub Mode借用了GitHub API，通过从GitHub仓库获取的信息抽取元数据，实现了在不生成元数据的情况下，博客也能够正常拿到元数据，给访客呈现正确的页面。在这个模式下，Fragy可以完全摆脱CI，用户只需要修改Markdown文档，更改就会立刻在页面上生效，而且用户不需要假设任何的服务器。

### Generate Pipeline

初版Fragy采用的是单一的生成脚本，但很显然这个方式是粗糙的、不具备可扩展性的。

所以在重构后的版本里，Fragy的生成改为了流水线模式。和常规的流水线不太一样，为了追求效率，流水线采用了异步模式，支持非常多生成任务并行，通过事件分发来保证执行上的先后顺序。

每一篇文章在被读取后都会分发到流水线内的各个生成器上，各个生成器再将产物通过事件分发出去，或者存入磁盘。

在这种模式下Fragy将具备更强大的拓展性，同时主题开发者也可以撰写生成器，甚至是构建一整条流水线，来满足主题自身的构建需要。

### Transformer

Transformer是一个还在规划中的内容，设计它的目标是让文章在生成过程中也变得可以操纵。不论是初版还是目前的Fragy，为了让文档在被修改后，修改可以立刻更新到生产的页面上，文章是不进入生成过程的，但是考虑到一些主题开发者与用户可能会有相关的需求，例如对某些文章进行加密等等，我们最终还是决定通过设计Transformer来实现这个能力。

它严格意义上只是介入了Webpack CopyPlugin的拷贝过程，在拷贝的流程中对文章内容进行额外的处理。这一个操作实际上是在生成之后的，因而Transformer对文章的任何修改都不会影响到元数据本身。

未来Fragy本身也会具备一些基于Transformer这个底层设计做的能力，比如给文章做插入空格的预处理，预先提取、编译文章内的MarkVue内容等等。

### 更多的元数据

目前Fragy支持的元数据相较于初版已经多了非常多，我们已经支持了分类、标签，基本上实现了Hexo支持的内容。

用户已经可以无痛地从Hexo迁移到Fragy，两边的数据是打通的，基本上不会遇到什么门槛。当然，由于Fragy是主题完全驱动页面呈现，所以这一系列元数据最终是否能够应用到页面上，还需要主题给予支持。

### 更多的主题

## 0x05 未来

说到这，Fragy的前世今生也基本上是说完了，它的底层逻辑、各个功能点的设计思路基本都写在了这篇文章里。

未来我们会向Fragy的生态填充更多的主题，同时也会对框架的能力进行填充和完善，相信我们很快就能够看到这个框架的一个1.x版本，它会是一个相对稳定且能满足绝大多数用户、主题开发者需求的版本。在它发布的同时，我们也会同时放出与之相对应的CLI Tool。

在这个版本之后，我们会花一些时间去着重地优化Fragy的开发体验，毕竟主题是整个框架的核心，框架本身只是一个壳子罢了。提升开发者的体验其实等效于愉悦开发者的心情、解放开发者的生产力，这有利于让整个Fragy生态出现更多更优质的主题。未来我们一大核心计划是推出提升主题开发效率的工具包，把所有Fragy的各类常用能力进行封装，这样开发者可以只关注页面的呈现，而不需要再关注Fragy的一些内部逻辑，比如文章解析等等。

### Link

如果你对Fragy的整个设计逻辑或者发展前景很看好，我们十分欢迎你关注这个项目：

[Fragy - GitHub](https://github.com/fragyjs/fragy)

同样，我们也非常欢迎所有有能力的开发者开发属于你自己的Fragy主题，让Fragy的生态变得更加多元、强壮。
